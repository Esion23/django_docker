name: Build Docker Image and Run Tests

on:
  # 手动触发工作流
  workflow_dispatch:
    inputs:
      repo:
        description: 'owner/repo'
        required: true
      commit:
        description: 'SHA'
        required: true

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      # 检出目标仓库的特定提交
      - name: Checkout target repository
        uses: actions/checkout@v3
        with:
          repository: ${{ github.event.inputs.repo }}
          ref: ${{ github.event.inputs.commit }}

      # 生成 Dockerfile
      - name: Generate Dockerfile
        run: |
          cat <<EOF > Dockerfile
          # 基础镜像
          FROM python:3.11

          # 设置工作目录
          WORKDIR /app

          # 复制项目文件到容器中
          COPY . .

          # 创建并激活虚拟环境，安装依赖项
          RUN python -m venv venv && \
              . venv/bin/activate && \
              if [ ! -d "django/tests" ]; then echo "Directory django/tests does not exist." && exit 1; fi && \
              cd django/tests && \
              echo "Current directory: $(pwd)" && \
              python -m pip install -e .. && \
              if [ ! -f "requirements/py3.txt" ]; then echo "File requirements/py3.txt does not exist." && exit 1; fi && \
              python -m pip install -r requirements/py3.txt

          # 运行测试脚本
          CMD ["/bin/bash", "-c", "venv/bin/python django/tests/runtests.py"]
          EOF
      # 构建 Docker 镜像
      - name: Build Docker image
        run: docker build -t my-test-image .

      # 运行 Docker 容器，创建虚拟环境，安装依赖并运行测试
      - name: run tests in Docker
        run: |
          docker run -it --name test-container my-test-image 